<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.css">
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <link rel="stylesheet" href="leaflet-routing-machine.css" >
    <link rel="stylesheet" href="Control.Geocoder.css" />
    <script src="Control.Geocoder.js"></script>
    <script type="text/javascript" src="movingMarker.js"></script>
    <script src="leaflet-routing-machine.min.js"></script>
    <script src="bower_components/moment/moment.js"></script>
    <title>Game Test</title>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
        }
    </style>

    <style>
        pre.ui-distance {
            position:absolute;
            bottom:10px;
            left:10px;
            padding:5px 10px;
            background:rgba(0,0,0,0.5);
            color:#fff;
            font-size:11px;
            line-height:18px;
            border-radius:3px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <pre id='distance' class='ui-distance'></pre>


    <script>
        // API CONVERSOR
        var convert = (function () {
            var conversions = {
                speed: {
                    ms:    1, // use m/s as our base unit
                    kmh:   3.6,
                    mph:   2.23693629,
                    knots: 1.94384449
                },

                distance: {
                    m:      1, // use meters as our base
                    inches: 39.3700787402, // can't use "in" as that's a keyword. Darn.
                    ft:     3.280839895,
                    mi:     0.000621371192,
                    nm:     0.000539956803 // nautical miles, not nanometers
                },

                mass: {
                    g:  1, // use grams as our base
                    lb: 0.002204622622,
                    oz: 0.0352739619
                }
            };

            function Unit(type, unit, base) {
                this.value = base * conversions[type][unit];
                this.to = {};
                for(var otherUnit in conversions[type]) {
                    (function (target) {
                        this.to[target] = function () {
                            return new Unit(type, target, base);
                        }
                    }).call(this, otherUnit);
                }
            }

            Unit.prototype = {
                yield: function () {
                    return this.valueOf();
                },

                toString: function () {
                    return String(this.value);
                },

                valueOf: function () {
                    return this.value;
                }
            };

            // my god, it's full of scopes!
            var types = {};
            for(var type in conversions) {
                (function (type) {
                    types[type] = function (value) {
                        var units = {};
                        for(var unit in conversions[type]) {
                            (function (unit) {
                                units[unit] = function () {
                                    return new Unit(type, unit, value / conversions[type][unit]);
                                }
                            }(unit));
                        }
                        return units;
                    };
                }(type));
            }

            return types;
        }());

        // INSTANCIA MAP
        var map = initialize_map(L.latLng(-7.240615,-35.931438));
        var msg;
        // SET TILE CALL FUNCTION
        add_tile_default(map);
        // ARRAY DE TIMES MEDIO EM CADA ESTADO DE PARADA DO MARKER.
        var time_stations = [];
        // ITINERARIO TEST ARRAY POINTS
        var itinerario_test = [[-7.240615,-35.931438],[-7.240836,-35.931953],[-7.240919,-35.931969],[-7.240968,-35.93196],[-7.241026,-35.931916],[-7.241056,-35.931863],[-7.24095,-35.931624],[-7.240512,-35.930657],[-7.240317,-35.930178],[-7.240139,-35.929838],[-7.240046,-35.929663],[-7.240011,-35.929597],[-7.239773,-35.929064],[-7.237735,-35.924307],[-7.237702,-35.923962],[-7.237683,-35.923831],[-7.237589,-35.923739],[-7.237394,-35.923514],[-7.237143,-35.922965],[-7.23612,-35.920733],[-7.236081,-35.920452],[-7.236128,-35.920316],[-7.236105,-35.920175],[-7.236018,-35.920061],[-7.235887,-35.920003],[-7.235641,-35.919659],[-7.235282,-35.918822],[-7.235228,-35.918696],[-7.233356,-35.914332],[-7.231633,-35.910411],[-7.2317,-35.910336],[-7.23174,-35.910243],[-7.231747,-35.910143],[-7.231721,-35.910045],[-7.231635,-35.909933],[-7.231518,-35.909874],[-7.231387,-35.909871],[-7.229501,-35.905498],[-7.229305,-35.905056],[-7.228608,-35.903478],[-7.228436,-35.903089],[-7.228109,-35.90235],[-7.227833,-35.901725],[-7.227653,-35.901318],[-7.227466,-35.900898],[-7.227252,-35.90041],[-7.2271,-35.900065],[-7.226868,-35.89957],[-7.226757,-35.899332],[-7.22646,-35.898697],[-7.226094,-35.897913],[-7.225671,-35.897008],[-7.225502,-35.896648],[-7.224872,-35.895301],[-7.224496,-35.894475],[-7.224296,-35.894035],[-7.224244,-35.893922],[-7.223959,-35.893297],[-7.223671,-35.892723],[-7.224246,-35.892648],[-7.224508,-35.89237],[-7.22457,-35.892306],[-7.224873,-35.891986],[-7.224823,-35.891684],[-7.224271,-35.891345],[-7.224201,-35.891239],[-7.224814,-35.889373],[-7.225326,-35.887733],[-7.22564,-35.8868],[-7.226003,-35.885726],[-7.226072,-35.88551],[-7.226302,-35.884818],[-7.226709,-35.884929],[-7.227139,-35.8849],[-7.227733,-35.884967],[-7.228576,-35.884788],[-7.228895,-35.884702],[-7.229211,-35.884637],[-7.229328,-35.884483],[-7.229364,-35.884233],[-7.229371,-35.883942],[-7.229394,-35.883786],[-7.229706,-35.882491],[-7.229817,-35.882026],[-7.229936,-35.881768],[-7.230183,-35.881479],[-7.230272,-35.881443],[-7.23078,-35.882118],[-7.230816,-35.882166],[-7.230975,-35.88249]];
        // CONTROL GENERATE ITINERARIO
        var control = generate_control_route(L.latLng(-7.240615,-35.931438), L.latLng(-7.230975,-35.88249));

        //DEF ICON FORMAT
        var LeafIcon = L.Icon.extend({
            options: {
                iconSize:     [38, 45],
                iconAnchor:   [20, 45],
                popupAnchor:  [-3, -76]
            }
        });

        //CALL FUNCTION
        fill_times_array(calcula_media_velocidade(calcula_tempo_milli(
                calcula_distancia(L.latLng(-7.240615,-35.931438), L.latLng(-7.230975,-35.88249)),
                calcula_kmh_to_ms(100)),itinerario_test), itinerario_test);
        // INSTANCIA DE BUS
        var busIcon = new LeafIcon({iconUrl: 'bus.png'}),
                bustwoIcon = new LeafIcon({iconUrl: 'bus2.png'});


        // INSTANCIA DE MARKER MOVING
        var myMovingMarker = L.Marker.movingMarker(itinerario_test,
                time_stations, {autostart: true, icon: busIcon}).addTo(map);
        //START
        myMovingMarker.start();
        //DRAW PERCURSO

        //CALL FUNCTION
        desenha_percurso(itinerario_test, map);

        // ESCUTA PARA DISPLAY POPUP
        myMovingMarker.on('end', function() {
            myMovingMarker.bindPopup('<b>Welcome !</b>', {closeOnClick: false})
                    .openPopup();
        });

        //CALL FUNCTION
        set_message_time({lat: -7.240615,lng:-35.931438},{lat:-7.230975,lng:-35.88249}, 100);
        //SET UI MSG
        var container = $('#distance').text(msg);

        console.log(calcula_custos_viagem(2, calcula_distancia(L.latLng(-7.240615,-35.931438), L.latLng(-7.230975,-35.88249))));
        console.log(calcula_auto_pagamento_empresa(2, calcula_distancia(L.latLng(-7.240615,-35.931438), L.latLng(-7.230975,-35.88249))));


        //--------------------------------------------------------------------------------------------------------------------------------------





        // generate control route
        function generate_control_route(p1, p2){
            return L.Routing.control({
                waypoints: [
                    p1,
                    p2
                ],
                draggableWaypoints: false,
                addWaypoints: false,
                show: false,
                pointMarkerStyle: {radius: 15, color: '#dddddd', fillColor: 'blue', opacity: 1, fillOpacity: 0.7},
                collapsible: true,
                routeWhileDragging: true,
                geocoder: L.Control.Geocoder.nominatim(),
                waypointNameFallback: function (latLng) {
                    function zeroPad(n) {
                        n = Math.round(n);
                        return n < 10 ? '0' + n : n;
                    }

                    function sexagesimal(p, pos, neg) {
                        var n = Math.abs(p),
                                degs = Math.floor(n),
                                mins = (n - degs) * 60,
                                secs = (mins - Math.floor(mins)) * 60,
                                frac = Math.round((secs - Math.floor(secs)) * 100);
                        return (n >= 0 ? pos : neg) + degs + 'Â°' +
                                zeroPad(mins) + '\'' +
                                zeroPad(secs) + '.' + zeroPad(frac) + '"';
                    }

                    return sexagesimal(latLng.lat, 'N', 'S') + ' ' + sexagesimal(latLng.lng, 'E', 'W');
                }
            }).addTo(map);
        }

        //METHOD TO GET ITINERARIO ARRAY GENERATED
        function get_text_generate_route(control){
            var arr = [];
            control.on('routesfound', function (e) {
                var routes = e.routes;
                routes[0].coordinates.forEach(function(obj){
                    arr.push([obj.lat, obj.lng]);
                });
                console.log(JSON.stringify(arr));
            });
        }

        // DESENHA PERCURSO PEDINDO ITINERARIO ARRAY E MAPA OBJECT
        function desenha_percurso(itinerario, map){
            L.polyline(itinerario, {color: 'red'}).addTo(map);
            map.fitBounds(itinerario);
        }

        //FUNCTION TO FILL TIMES ARRAY
        function fill_times_array(time_in_milli, itinerario_test){
            itinerario_test.forEach(function(po){
                time_stations.push(time_in_milli);
            });
        }

        /**
         * ADD TILE DEFAULT
         */
        function add_tile_default(map){
            L.tileLayer('http://{s}.tiles.mapbox.com/v4/thinhnvv.cieef6v3v025rs9lx3852m36x/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoidGhpbmhudnYiLCJhIjoiZjQzYWM1ZDQ4YjNkNjc5YzQwZjA5OWIwNTNhZDNhODMifQ.53wH0q9UO48XrvK_TUESmg',
                    { maxZoom: 18}).addTo(map);
        }

        /**
         * INICIALIZA MAPA PEDINDO PONTO INICIAL EX.: L.latLng(-7.240615,-35.931438)
         * @param point PONTO INICIAL EX.:L.latLng(-7.240615,-35.931438)
         * @returns {*} MAPA OBJECT
         */
        function initialize_map(point){
            map = L.map('map').setView([point.lat,point.lng], 18);
            return map;
        }

        /**
         * CALCULA MEDIA DE VELOCIDADE
         * @param total_milli TEMPO EM MILLISECONDS
         * @param array_points ARRAY DO PERCURSO
         * @returns {string} O TEMPO FIXED EM .2;
         */
        function calcula_media_velocidade(total_milli, array_points){
            return (total_milli/array_points.length).toFixed(2);
        }

        /**
         * TRANSFORMA KM/H EM M/S
         * @param kmh VELOCIDADE EM KM/H
         * @returns {*} VELOCIDADE EM M/S
         */
        function calcula_kmh_to_ms(kmh){
            var ms = convert.speed(kmh).kmh().to.ms();
            //console.log(ms+" m/s");
            return ms;
        }

        /**
         * CALCULA TEMPO EM MODO LEITURA
         * @param distancia DISTANCIA EM M
         * @param ms VELOCIDADE EM M/S
         * @returns {*} STRING EM MODO DE LEITURA
         */
        function calcula_tempo_humanize(distancia, ms){
            var t = distancia/ms;
            //console.log(t+" segundos");
            var tempo = moment.duration(t, 'seconds').humanize();
            return tempo;
        }

        /**
         * CALCULA TEMPO EM MILLISEGUNDOS
         * @param distancia DISTANCIA EM M
         * @param ms VELOCIDADE EM M/S
         * @returns {*} TEMPO EM MILLISEGUNDOS
         */
        function calcula_tempo_milli(distancia, ms){
            var t = distancia/ms;
            //console.log(t+" segundos");
            var tempo = moment.duration(t, 'seconds');
            return tempo.asMilliseconds();
        }

        /**
         * CALCULA CUSTOS DE VIAGEM BASEADOS EM CARGA E DISTANCIA
         * @param carga TIPO DE CARGA 0, 1 OU 2.
         * @param distancia DISTANCIA EM M
         * @returns {string} CUSTOS DE VIAGEM EM R$
         */
        function calcula_custos_viagem(carga, distancia){
            var taxa = [0.10, 0.20, 0.30];
            return (distancia * taxa[carga-1]).toFixed(2);
        }

        /**
         * CALCULA PAGAMENTO DADO PELA EMPRESA AO ENTREGAR A CARGA.
         * @param carga TIPO DE CARGA 0, 1 OU 2.
         * @param distancia DISTANCIA EM M
         * @returns {number} O VALOR EM R$ A SER DEPOSITADO.
         */
        function calcula_auto_pagamento_empresa(carga, distancia){
            return calcula_custos_viagem(carga, distancia) * 1.25;
        }

        /**
         * SET MENSAGEM DE LEITURA NO MAPA.
         * @param p1 PONTO INICIAL EX.: L.latLng(p1.lat,p1.lng)
         * @param p2 PONTO FINAL EX.: L.latLng(p1.lat,p1.lng)
         * @param velocidade VELOCIDADE EM KM/H
         */
        function set_message_time(p1, p2, velocidade){
            msg =  calcula_tempo_humanize(calcula_distancia(L.latLng(p1.lat,p1.lng), L.latLng(p2.lat, p2.lng)), calcula_kmh_to_ms(velocidade)).toString();
        }

        /**
         * CALCULA DISTANCIA DO PONTO INICIAL AO PONTO FINAL.
         * @param p1 PONTO INICIAL EX.: L.latLng(p1.lat,p1.lng)
         * @param p2 PONTO FINAL EX.: L.latLng(p1.lat,p1.lng)
         * @returns {string}
         */
        function calcula_distancia(p1, p2){
            var fc = L.latLng(p1.lat,p1.lng);
            var c = L.latLng(p2.lat,p2.lng);
            var result = (fc.distanceTo(c)).toFixed(0);
            //console.log(result+ " metros");
            return result;
        }

    </script>
</body>
</html>